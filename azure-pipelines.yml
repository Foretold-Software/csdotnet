# Copyright (c) Foretold Software, LLC. All rights reserved. Licensed under the Microsoft Public License (MS-PL). See the license.md file in the project root directory for full license information.

##################################################################################
#   Filename: azure-pipelines.yml
#
#   Description:
#       This file contains elements necessary to build, test,
#       and deploy the CS.Net project.
#
##################################################################################

trigger:
- master

pool:
  vmImage: 'windows-latest'

variables:
  versionMajorMinor: '0.1.'
  productVersion:  $[format('{0}{1}', variables['versionMajorMinor'], counter(variables['versionMajorMinor'], 100))]
  solution: '**/*.sln'
  buildPlatform: 'Any CPU'
  buildConfiguration: 'Release'

name: $(productVersion)

stages:
- stage: build
  displayName: Build
  jobs:

  - job: build
    displayName: Build
    steps:

    - task: NuGetToolInstaller@1
      displayName: Nuget - Install tool

    - task: NuGetCommand@2
      displayName: Nuget - Restore
      inputs:
        restoreSolution: '$(solution)'

    - task: VSBuild@1
      displayName: Build solution
      inputs:
        solution: '$(solution)'
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'
        msbuildArgs: '/p:Version=$(productVersion)'

    - task: VSTest@2
      displayName: Run unit tests
      inputs:
        platform: '$(buildPlatform)'
        configuration: '$(buildConfiguration)'

    - task: NuGetCommand@2
      name: PushNugetPackage
      displayName: Nuget - Push to Feed
      inputs:
        command: push
        packagesToPush: 'src/CS.Net/**/*.nupkg;!src/CS.Net/**/*.symbols.nupkg'
        nuGetFeedType: internal
        publishVstsFeed: '60593458-e441-4df1-950e-1608e9efe6e8/834a5c7f-61e8-4154-8d99-0c0f0822d65e'
